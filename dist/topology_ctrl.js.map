{"version":3,"sources":["../src/topology_ctrl.js"],"names":["MetricsPanelCtrl","_","kbn","rendering","TopologyCtrl","$scope","$injector","$rootScope","panelDefaults","links","datasource","maxDataPoints","interval","targets","cacheTimeout","graph","nodes","edges","minEdgeSize","minNodeSize","edgeType","edgeLabelSize","draggable","trackable","filterMode","showEdgeLabels","varList","edgeWeight","dstNode","srcNode","colorNode","colorMode","colors","thresholds","defaults","panel","events","on","onDataReceived","bind","onDataError","onInitEditMode","onRefresh","loadTemplatingVars","addEditorTab","unitFormats","getUnitFormats","data","render","dataList","thisArg","meta","id","forEach","el","hasOwnProperty","datapoints","it","idx","regex","m","exec","target","parseGraph","scope","elem","attrs","ctrl","str","hash","s","l","i","length","charCodeAt","h","item","findIndex","node","_label","push","label","x","Math","random","y","size","parseInt","color","nameToColor","handleThresholdColor","edge","source","type","hover_color","_type","_idx","_fidx","_lidx","ref","copy","colorIndex","newColor","d","varlist","getFields","text","metricFindQuery","database","measurement","isEqual","datasourceSrv","get","then","load_vars","err","console","log","templateUrl"],"mappings":"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","sourcesContent":["import { MetricsPanelCtrl } from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport rendering from './rendering';\n\nexport class TopologyCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope) {\n    super($scope, $injector);\n    this.$rootScope = $rootScope;\n    var panelDefaults = {\n      links: [],\n      datasource: null,\n      maxDataPoints: 3,\n      interval: null,\n      targets: [{}],\n      cacheTimeout: null,\n\n      graph: {\n        nodes: [],\n        edges: [],\n      },\n      minEdgeSize: 4,\n      minNodeSize: 4,\n      edgeType: 'curvedArrow',\n      edgeLabelSize: 'proportional',\n      draggable: false,\n      trackable: false,\n      filterMode: null,\n      showEdgeLabels: false,\n      varList: [],\n      edgeWeight: null,\n      dstNode: null,\n      srcNode: null,\n      colorNode: null,\n\n      colorMode: null,\n      colors: ['rgba(245, 54, 54, 0.9)', 'rgba(237, 129, 40, 0.89)', 'rgba(50, 172, 45, 0.97)'],\n      thresholds: [],\n    };\n\n    _.defaults(this.panel, panelDefaults);\n\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('refresh', this.onRefresh.bind(this));\n  }\n\n  onRefresh() {\n    this.loadTemplatingVars();\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/gretamosa-topology-panel/editor.html', 2);\n    this.unitFormats = kbn.getUnitFormats();\n    this.loadTemplatingVars();\n  }\n\n  onDataError() {\n    this.data = []; \n    this.graph = { nodes: [], edges: [] };\n    this.render();\n  }\n\n  onDataReceived(dataList) {\n    var thisArg = this;\n\n    if (thisArg.datasource.meta.id === 'elasticsearch') {\n      dataList.forEach((el) => {\n        if (el.hasOwnProperty('datapoints') && el.datapoints !== thisArg.data) {\n          thisArg.data = el.datapoints;\n        }\n      });\n    } else if (thisArg.datasource.meta.id === 'influxdb') {\n      thisArg.data = [];\n      dataList.forEach((el) => {\n        if (el.hasOwnProperty('datapoints')) {\n          el.datapoints.forEach((it,idx) => {\n            if (!thisArg.data[idx]) {\n              thisArg.data[idx] = {};\n            }\n            const regex = /(\\S+)(\\.)(\\S+)/gmi;\n            const m = regex.exec(el.target);\n            thisArg.data[idx][(m!==null?m[3]:el.target)] = it[0];\n          }); \n        }\n      });\n    }\n    thisArg.parseGraph(thisArg.data);\n    thisArg.render();\n  }\n\n  link(scope, elem, attrs, ctrl) {\n    rendering(scope, elem, attrs, ctrl);\n  }\n\n  nameToColor(str) {\n    if (str) {\n      var hash = 0, s=30, l=50;\n      for (var i = 0; i < str.length; i++) {\n        hash = str.charCodeAt(i) + ((hash << 5) - hash);\n      }\n\n      var h = hash % 360;\n      return 'hsl('+h+', '+s+'%, '+l+'%)';\n    } else {\n      return '#666666';\n    }\n  }\n\n  parseGraph(data) {\n    let thisArg = this;\n\n    thisArg.panel.graph.nodes = [];\n    thisArg.panel.graph.edges = [];\n    _.forEach(data, (item) => {\n      var idx = _.findIndex(thisArg.panel.graph.nodes, node => { return item[thisArg.panel.srcNode] === node.id; });\n      if (idx == -1) {\n        var _label = (thisArg.panel.colorNode?item[thisArg.panel.colorNode]+': '+item[thisArg.panel.srcNode]:item[thisArg.panel.srcNode]);\n        thisArg.panel.graph.nodes.push({\n          id: item[thisArg.panel.srcNode],\n          label: _label,\n          x: Math.random(),\n          y: Math.random(),\n          size: parseInt(item[thisArg.panel.edgeWeight]),\n          color: thisArg.nameToColor(_label),\n        });\n        thisArg.handleThresholdColor('nodes',idx);\n      } else {\n        thisArg.panel.graph.nodes[idx].size+=parseInt(item[thisArg.panel.edgeWeight]);\n        thisArg.handleThresholdColor('nodes',idx);\n      }\n      idx = _.findIndex(thisArg.panel.graph.nodes, node => { return item[thisArg.panel.dstNode] === node.id; });\n      if (idx == -1) {\n        var _label = (thisArg.panel.colorNode?item[thisArg.panel.colorNode]+': '+item[thisArg.panel.srcNode]:item[thisArg.panel.dstNode]);\n        thisArg.panel.graph.nodes.push({\n          id: item[thisArg.panel.dstNode],\n          label: _label,\n          x: Math.random(),\n          y: Math.random(),\n          size: parseInt(item[thisArg.panel.edgeWeight]),\n          color: thisArg.nameToColor(_label),\n        });\n        thisArg.handleThresholdColor('nodes',idx);\n      } else {\n        thisArg.panel.graph.nodes[idx].size+=parseInt(item[thisArg.panel.edgeWeight]);\n        thisArg.handleThresholdColor('nodes',idx);\n      }\n      idx = _.findIndex(thisArg.panel.graph.edges, edge => { return item[thisArg.panel.srcNode]+'_'+item[thisArg.panel.dstNode] === edge.id; });\n      if (idx == -1) {\n        thisArg.panel.graph.edges.push({\n          id: item[thisArg.panel.srcNode]+'_'+item[thisArg.panel.dstNode],\n          source: item[thisArg.panel.srcNode],\n          target: item[thisArg.panel.dstNode],\n          label: (thisArg.panel.showEdgeLabels?thisArg.panel.edgeWeight+':'+parseInt(item[thisArg.panel.edgeWeight]):''),\n          size: parseInt(item[thisArg.panel.edgeWeight]),\n          type: thisArg.panel.edgeType,\n          color: '#ccc',\n          hover_color: '#000',\n        });\n        thisArg.handleThresholdColor('edges',idx);\n      } else {\n        thisArg.panel.graph.edges[idx].size+=parseInt(item[thisArg.panel.edgeWeight]);\n        if (thisArg.panel.showEdgeLabels) {\n          thisArg.panel.graph.edges[idx].label=thisArg.panel.edgeWeight+':'+thisArg.panel.graph.edges[idx].size;\n        }\n        thisArg.handleThresholdColor('edges',idx);\n      }\n    }); \n  }\n\n  handleThresholdColor(_type, _idx) {\n    if (_type === this.panel.colorMode && this.panel.thresholds.length > 0) {\n      var _fidx = _idx == -1 ? this.panel.graph[_type].length-1 : _idx;\n      var _lidx = this.panel.thresholds.findIndex((el) => {\n        return this.panel.graph[_type][_fidx].size < el;\n      });\n      _lidx = _lidx == -1 ? this.panel.thresholds.length : _lidx;\n      this.panel.graph[_type][_fidx].color = this.panel.colors[_lidx];\n    }\n  }\n\n  invertColorOrder() {\n    var ref = this.panel.colors;\n    var copy = ref[0];\n    ref[0] = ref[2];\n    ref[2] = copy;\n    this.render();\n  }\n\n  onColorChange(colorIndex) {\n    var thisArg = this;\n    return newColor => {\n      thisArg.panel.colors[colorIndex] = newColor;\n      thisArg.render();\n    };\n  }\n\n  async load_vars(el, d) {\n    var x, varlist = [''];\n    if (d.meta.id === 'elasticsearch' && typeof d.getFields === 'function') {\n      x = await d.getFields({});\n      x.forEach((it) => { varlist.push(it.text); });\n    } else if (d.meta.id === 'influxdb') {\n      // Only one measurement is allowed\n      x = await d.metricFindQuery('SHOW FIELD KEYS ON '+d.database+' FROM '+el.panel.targets[0].measurement);\n      x.forEach((it) => { varlist.push(it.text); });\n    }\n    if (!_.isEqual(varlist, el.panel.varList)) {\n      el.panel.varList = varlist;\n    }\n  }\n\n  loadTemplatingVars() {\n    let thisArg = this;\n\n    if (thisArg.panel.datasource) {\n      thisArg.datasourceSrv.get(thisArg.panel.datasource).then(\n        function(datasource) {\n          thisArg.load_vars(thisArg, datasource);\n        }.bind(thisArg),\n        function(err) {\n          console.log(err);\n        }\n      );\n    }\n  }\n}\n\nTopologyCtrl.templateUrl = 'module.html';\n"],"file":"topology_ctrl.js"}